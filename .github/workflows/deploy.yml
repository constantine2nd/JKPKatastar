name: Deploy to VPS

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Add VPS to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Create deployment script
        run: |
          cat > deploy.sh << 'SCRIPT_EOF'
          #!/bin/bash
          set -e

          echo "üèõÔ∏è  JKP Katastar - Remote Deployment"
          echo "===================================="

          # Navigate to deployment directory
          DEPLOY_DIR="/opt/jkp-katastar"
          mkdir -p $DEPLOY_DIR
          cd $DEPLOY_DIR

          # Stop existing services if they exist
          if [ -d "JKPKatastar" ] && [ -f "JKPKatastar/docker-compose.yml" ]; then
            echo "üõë Stopping existing services..."
            cd JKPKatastar
            if command -v docker > /dev/null 2>&1 && docker compose version > /dev/null 2>&1; then
              docker compose down --timeout 30 || true
            elif command -v docker-compose > /dev/null 2>&1; then
              docker-compose down --timeout 30 || true
            else
              echo "‚ö†Ô∏è  Docker Compose not found, skipping service stop"
            fi
            cd $DEPLOY_DIR
          fi

          # Backup existing deployment
          if [ -d "JKPKatastar" ]; then
            echo "üì¶ Backing up existing deployment..."
            mv JKPKatastar JKPKatastar-backup-$(date +%Y%m%d-%H%M%S) || true
          fi

          # Clone fresh repository
          echo "üì• Cloning repository..."
          git clone https://github.com/${{ github.repository }}.git JKPKatastar
          cd JKPKatastar

          # Create production environment file
          echo "‚öôÔ∏è  Setting up environment..."
          cat > .env << 'ENV_EOF'
          NODE_ENV=production
          PORT=5000
          MONGO_USERNAME=admin
          MONGO_PASSWORD=REPLACE_MONGO_PASSWORD
          MONGO_DATABASE=graves_prod
          MONGO_URI=mongodb://admin:REPLACE_MONGO_PASSWORD@mongodb:27017/graves_prod?authSource=admin
          JWT_SECRET=REPLACE_JWT_SECRET
          EMAIL_SERVICE=REPLACE_EMAIL_SERVICE
          EMAIL_HOST=REPLACE_EMAIL_HOST
          EMAIL_PORT=REPLACE_EMAIL_PORT
          EMAIL_USER=REPLACE_EMAIL_USER
          EMAIL_SECRET=REPLACE_EMAIL_SECRET
          CLIENT_HOST_URI=http://${{ secrets.VPS_HOST }}:3000
          REACT_APP_API_URL=http://${{ secrets.VPS_HOST }}:5000/api
          REACT_APP_MAP_CENTER_LAT=45.2671
          REACT_APP_MAP_CENTER_LON=19.8335
          CHOKIDAR_USEPOLLING=false
          GENERATE_SOURCEMAP=false
          ENV_EOF

          # Replace placeholders with actual values
          sed -i "s/REPLACE_MONGO_PASSWORD/$MONGO_PASSWORD/g" .env
          sed -i "s/REPLACE_JWT_SECRET/$JWT_SECRET/g" .env
          sed -i "s/REPLACE_EMAIL_SERVICE/$EMAIL_SERVICE/g" .env
          sed -i "s/REPLACE_EMAIL_HOST/$EMAIL_HOST/g" .env
          sed -i "s/REPLACE_EMAIL_PORT/$EMAIL_PORT/g" .env
          sed -i "s/REPLACE_EMAIL_USER/$EMAIL_USER/g" .env
          sed -i "s/REPLACE_EMAIL_SECRET/$EMAIL_SECRET/g" .env

          # Create data directories
          mkdir -p $DEPLOY_DIR/data/mongodb
          mkdir -p $DEPLOY_DIR/logs

          # Check if Docker is running
          if ! docker info > /dev/null 2>&1; then
            echo "‚ùå Docker is not running!"
            exit 1
          fi

          # Check Docker Compose (newer 'docker compose' or legacy 'docker-compose')
          if docker compose version > /dev/null 2>&1; then
            echo "‚úÖ Docker Compose (v2) available: $(docker compose version)"
            COMPOSE_CMD="docker compose"
          elif command -v docker-compose > /dev/null 2>&1; then
            echo "‚úÖ Docker Compose (v1) available: $(docker-compose --version)"
            COMPOSE_CMD="docker-compose"
          else
            echo "‚öôÔ∏è  Installing Docker Compose..."
            curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            chmod +x /usr/local/bin/docker-compose
            COMPOSE_CMD="docker-compose"
            echo "‚úÖ Docker Compose installed"
          fi

          # Pull base images first
          echo "üì¶ Pulling base Docker images..."
          docker pull mongo:6.0 || true
          docker pull node:18-alpine || true
          docker pull nginx:alpine || true

          # Build and start services
          echo "üî® Building and starting services..."
          $COMPOSE_CMD up --build -d --remove-orphans

          # Wait for containers to start
          echo "‚è≥ Waiting for containers to start..."
          sleep 30

          # Check container status
          echo "üìä Container Status:"
          $COMPOSE_CMD ps

          # Show logs for debugging
          echo "üìã Recent logs:"
          $COMPOSE_CMD logs --tail=50

          # Wait for services to be ready
          echo "ü©∫ Waiting for services to be ready..."

          # Wait for MongoDB
          for i in {1..30}; do
            if $COMPOSE_CMD exec -T mongodb mongosh --eval "db.adminCommand('ping')" --quiet > /dev/null 2>&1; then
              echo "‚úÖ MongoDB is ready"
              break
            fi
            echo "Waiting for MongoDB... ($i/30)"
            sleep 5
          done

          # Wait for Backend
          for i in {1..30}; do
            if $COMPOSE_CMD exec -T backend wget --spider --quiet --timeout=5 --tries=1 http://localhost:5000/api/health > /dev/null 2>&1; then
              echo "‚úÖ Backend is ready"
              break
            fi
            echo "Waiting for Backend... ($i/30)"
            sleep 5
          done

          # Wait for Frontend
          for i in {1..30}; do
            if $COMPOSE_CMD exec -T frontend wget --spider --quiet --timeout=5 --tries=1 http://localhost:80 > /dev/null 2>&1; then
              echo "‚úÖ Frontend is ready"
              break
            fi
            echo "Waiting for Frontend... ($i/30)"
            sleep 5
          done

          # Final status check
          echo "üìä Final Service Status:"
          $COMPOSE_CMD ps

          # Clean up old images
          echo "üßπ Cleaning up old Docker images..."
          docker image prune -f || true

          # Remove old backups (keep only last 3)
          echo "üóÇÔ∏è  Cleaning up old backups..."
          cd $DEPLOY_DIR
          ls -dt JKPKatastar-backup-* 2>/dev/null | tail -n +4 | xargs rm -rf 2>/dev/null || true

          echo "üéâ Deployment completed!"
          echo ""
          echo "üåê Access URLs:"
          echo "   Frontend: http://${{ secrets.VPS_HOST }}:3000"
          echo "   Backend:  http://${{ secrets.VPS_HOST }}:5000/api"
          echo "   Health:   http://${{ secrets.VPS_HOST }}:5000/api/health"
          SCRIPT_EOF

          chmod +x deploy.sh

      - name: Deploy to VPS
        run: |
          scp deploy.sh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/tmp/
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} \
            "MONGO_PASSWORD='${{ secrets.MONGO_PASSWORD }}' \
             JWT_SECRET='${{ secrets.JWT_SECRET }}' \
             EMAIL_SERVICE='${{ secrets.EMAIL_SERVICE }}' \
             EMAIL_HOST='${{ secrets.EMAIL_HOST }}' \
             EMAIL_PORT='${{ secrets.EMAIL_PORT }}' \
             EMAIL_USER='${{ secrets.EMAIL_USER }}' \
             EMAIL_SECRET='${{ secrets.EMAIL_SECRET }}' \
             /tmp/deploy.sh"

      - name: Verify deployment
        run: |
          echo "üîç Verifying deployment..."
          sleep 60

          # Check if services are responding
          FRONTEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 10 --max-time 30 http://${{ secrets.VPS_HOST }}:3000 || echo "000")
          BACKEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 10 --max-time 30 http://${{ secrets.VPS_HOST }}:5000/api/health || echo "000")

          echo "Frontend Status: HTTP $FRONTEND_STATUS"
          echo "Backend Status: HTTP $BACKEND_STATUS"

          if [ "$FRONTEND_STATUS" = "200" ] || [ "$FRONTEND_STATUS" = "301" ] || [ "$FRONTEND_STATUS" = "302" ]; then
            echo "‚úÖ Frontend is responding"
            FRONTEND_OK=true
          else
            echo "‚ö†Ô∏è  Frontend not responding properly"
            FRONTEND_OK=false
          fi

          if [ "$BACKEND_STATUS" = "200" ]; then
            echo "‚úÖ Backend API is responding"
            BACKEND_OK=true
          else
            echo "‚ö†Ô∏è  Backend API not responding properly"
            BACKEND_OK=false
          fi

          # Get service status from VPS
          echo ""
          echo "üìä Service Status on VPS:"
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "cd /opt/jkp-katastar/JKPKatastar && (docker compose ps 2>/dev/null || docker-compose ps 2>/dev/null || echo 'No compose found')"

      - name: Cleanup
        if: always()
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "rm -f /tmp/deploy.sh" || true

      - name: Deployment Summary
        if: always()
        run: |
          echo "üìã Deployment Summary"
          echo "===================="
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          if [ "${{ job.status }}" == "success" ]; then
            echo "üéâ Deployment completed successfully!"
            echo "üåê Frontend: http://${{ secrets.VPS_HOST }}:3000"
            echo "üîß Backend API: http://${{ secrets.VPS_HOST }}:5000/api"
            echo "ü©∫ Health Check: http://${{ secrets.VPS_HOST }}:5000/api/health"
          else
            echo "‚ùå Deployment encountered issues. Check the logs above."
          fi
          echo ""
          echo "‚ÑπÔ∏è  To check logs manually:"
          echo "   ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}"
          echo "   cd /opt/jkp-katastar/JKPKatastar"
          echo "   docker compose logs  # or docker-compose logs"
