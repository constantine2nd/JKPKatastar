#!/bin/bash
# JKP Katastar - Deployment Configuration
# Centralized configuration for all deployment scripts and workflows
# Source this file in other scripts to use consistent settings

# =============================================================================
# SERVER CONFIGURATION
# =============================================================================

# VPS Server Details (can be overridden by environment variables)
export VPS_HOST="${VPS_HOST:-194.146.58.124}"
export VPS_USER="${VPS_USER:-root}"
export VPS_PORT="${VPS_PORT:-22}"

# =============================================================================
# PROJECT CONFIGURATION
# =============================================================================

# Project Details
export PROJECT_NAME="${PROJECT_NAME:-JKPKatastar}"
export GITHUB_REPOSITORY="${GITHUB_REPOSITORY:-constantine2nd/JKPKatastar}"
export DEFAULT_BRANCH="${DEFAULT_BRANCH:-main}"

# Directory Structure
export DEPLOY_DIR="${DEPLOY_DIR:-/opt/jkp-katastar}"
export DATA_DIR="${DATA_DIR:-/opt/jkp-katastar/data}"
export LOGS_DIR="${LOGS_DIR:-/opt/jkp-katastar/logs}"
export BACKUP_DIR="${BACKUP_DIR:-/opt/jkp-katastar/backups}"

# =============================================================================
# APPLICATION CONFIGURATION
# =============================================================================

# Service Ports
export FRONTEND_PORT="${FRONTEND_PORT:-3000}"
export BACKEND_PORT="${BACKEND_PORT:-5000}"
export MONGODB_PORT="${MONGODB_PORT:-27017}"

# Service URLs (auto-generated from VPS_HOST and ports)
export FRONTEND_URL="http://${VPS_HOST}:${FRONTEND_PORT}"
export BACKEND_URL="http://${VPS_HOST}:${BACKEND_PORT}"
export API_URL="${BACKEND_URL}/api"
export HEALTH_URL="${API_URL}/health"

# Application Environment
export NODE_ENV="${NODE_ENV:-production}"
export MONGO_DATABASE="${MONGO_DATABASE:-graves_prod}"
export MONGO_USERNAME="${MONGO_USERNAME:-admin}"

# =============================================================================
# DEPLOYMENT CONFIGURATION
# =============================================================================

# Docker Configuration
export COMPOSE_PROJECT_NAME="${COMPOSE_PROJECT_NAME:-jkp-katastar}"
export DOCKER_BUILDKIT="${DOCKER_BUILDKIT:-1}"

# Deployment Settings
export DEPLOYMENT_TIMEOUT="${DEPLOYMENT_TIMEOUT:-300}"
export SERVICE_STARTUP_WAIT="${SERVICE_STARTUP_WAIT:-60}"
export HEALTH_CHECK_RETRIES="${HEALTH_CHECK_RETRIES:-30}"
export HEALTH_CHECK_INTERVAL="${HEALTH_CHECK_INTERVAL:-5}"

# Backup Settings
export BACKUP_RETENTION_COUNT="${BACKUP_RETENTION_COUNT:-3}"
export AUTO_BACKUP_BEFORE_DEPLOY="${AUTO_BACKUP_BEFORE_DEPLOY:-true}"

# =============================================================================
# MONITORING CONFIGURATION
# =============================================================================

# Resource Limits (in MB)
export MIN_MEMORY_MB="${MIN_MEMORY_MB:-256}"
export MIN_DISK_MB="${MIN_DISK_MB:-2048}"
export DISK_WARNING_THRESHOLD="${DISK_WARNING_THRESHOLD:-85}"

# Log Settings
export LOG_MAX_SIZE="${LOG_MAX_SIZE:-10m}"
export LOG_MAX_FILES="${LOG_MAX_FILES:-3}"

# =============================================================================
# SECURITY CONFIGURATION
# =============================================================================

# SSH Settings
export SSH_KEY_PATH="${SSH_KEY_PATH:-~/.ssh/github_actions}"
export SSH_KEY_COMMENT="${SSH_KEY_COMMENT:-github-actions@jkp-katastar}"

# Firewall Ports (space-separated list)
export ALLOWED_PORTS="${ALLOWED_PORTS:-22 3000 5000}"

# =============================================================================
# DEVELOPMENT/TESTING OVERRIDES
# =============================================================================

# Override for local development/testing
if [ "${ENVIRONMENT}" = "development" ]; then
    export NODE_ENV="development"
    export MONGO_DATABASE="graves_dev"
    export FRONTEND_URL="http://localhost:${FRONTEND_PORT}"
    export BACKEND_URL="http://localhost:${BACKEND_PORT}"
    export API_URL="${BACKEND_URL}/api"
    export HEALTH_URL="${API_URL}/health"
fi

# Override for staging environment
if [ "${ENVIRONMENT}" = "staging" ]; then
    export NODE_ENV="staging"
    export MONGO_DATABASE="graves_staging"
fi

# =============================================================================
# UTILITY FUNCTIONS
# =============================================================================

# Function to display current configuration
show_config() {
    echo "üîß JKP Katastar Deployment Configuration"
    echo "========================================="
    echo "Environment: ${ENVIRONMENT:-production}"
    echo "VPS Host: ${VPS_HOST}"
    echo "Project: ${PROJECT_NAME}"
    echo "Repository: ${GITHUB_REPOSITORY}"
    echo "Deploy Directory: ${DEPLOY_DIR}"
    echo ""
    echo "Service URLs:"
    echo "  Frontend: ${FRONTEND_URL}"
    echo "  Backend: ${BACKEND_URL}"
    echo "  API: ${API_URL}"
    echo "  Health: ${HEALTH_URL}"
    echo ""
    echo "Database:"
    echo "  Name: ${MONGO_DATABASE}"
    echo "  Username: ${MONGO_USERNAME}"
    echo ""
}

# Function to validate configuration
validate_config() {
    local errors=0

    # Required variables
    if [ -z "${VPS_HOST}" ]; then
        echo "‚ùå VPS_HOST is required"
        errors=$((errors + 1))
    fi

    if [ -z "${PROJECT_NAME}" ]; then
        echo "‚ùå PROJECT_NAME is required"
        errors=$((errors + 1))
    fi

    if [ -z "${GITHUB_REPOSITORY}" ]; then
        echo "‚ùå GITHUB_REPOSITORY is required"
        errors=$((errors + 1))
    fi

    # Port validation
    if ! [[ "${FRONTEND_PORT}" =~ ^[0-9]+$ ]] || [ "${FRONTEND_PORT}" -lt 1 ] || [ "${FRONTEND_PORT}" -gt 65535 ]; then
        echo "‚ùå FRONTEND_PORT must be a valid port number (1-65535)"
        errors=$((errors + 1))
    fi

    if ! [[ "${BACKEND_PORT}" =~ ^[0-9]+$ ]] || [ "${BACKEND_PORT}" -lt 1 ] || [ "${BACKEND_PORT}" -gt 65535 ]; then
        echo "‚ùå BACKEND_PORT must be a valid port number (1-65535)"
        errors=$((errors + 1))
    fi

    if [ $errors -eq 0 ]; then
        echo "‚úÖ Configuration validation passed"
        return 0
    else
        echo "‚ùå Configuration validation failed with $errors errors"
        return 1
    fi
}

# Function to export environment for Docker Compose
export_docker_env() {
    cat > "${DEPLOY_DIR}/${PROJECT_NAME}/.env" << EOF
NODE_ENV=${NODE_ENV}
PORT=${BACKEND_PORT}
MONGO_USERNAME=${MONGO_USERNAME}
MONGO_PASSWORD=${MONGO_PASSWORD}
MONGO_DATABASE=${MONGO_DATABASE}
MONGO_URI=mongodb://${MONGO_USERNAME}:${MONGO_PASSWORD}@mongodb:${MONGODB_PORT}/${MONGO_DATABASE}?authSource=admin
JWT_SECRET=${JWT_SECRET}
EMAIL_SERVICE=${EMAIL_SERVICE:-}
EMAIL_HOST=${EMAIL_HOST:-}
EMAIL_PORT=${EMAIL_PORT:-587}
EMAIL_USER=${EMAIL_USER:-}
EMAIL_SECRET=${EMAIL_SECRET:-}
CLIENT_HOST_URI=http://${VPS_HOST}:${FRONTEND_PORT}
REACT_APP_API_URL=http://${VPS_HOST}:${BACKEND_PORT}/api
REACT_APP_MAP_CENTER_LAT=${MAP_CENTER_LAT:-45.2671}
REACT_APP_MAP_CENTER_LON=${MAP_CENTER_LON:-19.8335}
CHOKIDAR_USEPOLLING=false
GENERATE_SOURCEMAP=false
EOF
}

# =============================================================================
# AUTO-DETECTION
# =============================================================================

# Auto-detect if running in GitHub Actions
if [ "${GITHUB_ACTIONS}" = "true" ]; then
    export ENVIRONMENT="ci"
    echo "ü§ñ Detected GitHub Actions environment"
fi

# Auto-detect if running on the VPS server
if command -v curl > /dev/null 2>&1; then
    CURRENT_IP=$(curl -s --max-time 10 ifconfig.me 2>/dev/null || echo "unknown")
    if [ "${CURRENT_IP}" = "${VPS_HOST}" ]; then
        export ON_VPS_SERVER="true"
        echo "üñ•Ô∏è  Detected execution on VPS server"
    fi
fi

# =============================================================================
# INITIALIZATION MESSAGE
# =============================================================================

if [ "${1}" = "show" ]; then
    show_config
elif [ "${1}" = "validate" ]; then
    validate_config
else
    echo "üì¶ JKP Katastar deployment configuration loaded"
    echo "   Run with 'show' to display configuration"
    echo "   Run with 'validate' to validate configuration"
fi
